apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dex-server.fullname" . }}
  labels:
    {{- include "dex-server.labels" . | nindent 4 }}
data:
  config.yaml: |
    issuer: {{ .Values.global.auth.oidcIssuerUrl }}
    storage:
      type: postgres
      config:
        host: {{ .Values.global.database.host }}
        port: {{ .Values.global.database.port }}
        database: {{ .Values.database.database }}
        user: {{ .Values.global.database.username }}
        password: {{ .Values.database.password }}
        ssl:
          mode: {{ .Values.global.database.ssl.mode }}

    # TODO(aya): set up grpc API
    web:
      http: 0.0.0.0:{{ .Values.httpPort }}

    oauth2:
      skipApprovalScreen: true
      passwordConnector: local

    staticClients:
    - id: {{ .Values.client.id }}
      redirectURIs:
      - {{ .Values.client.redirectUrl }}
      name: {{ .Values.client.name }}
      secret: {{ .Values.client.secret }}

    enablePasswordDB: true
    staticPasswords:
    - userID: {{ .Values.admin.id }}
      username: {{ .Values.admin.user }}
      email: {{ .Values.admin.email }}
      hash: {{ .Values.admin.password }}
